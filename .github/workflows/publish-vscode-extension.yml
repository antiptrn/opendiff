name: Publish VS Code Extension

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: publish-vscode-extension
  cancel-in-progress: false

jobs:
  publish:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.release.tag_name, 'vscode-extension-v')
    runs-on: ubuntu-latest
    env:
      EXT_DIR: packages/vscode-extension
      VSIX_PATH: opendiff-local-review.vsix
      VSCE_PAT: ${{ secrets.VSCE_PAT }}
      OVSX_PAT: ${{ secrets.OVSX_PAT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Validate publish secrets
        run: |
          test -n "$VSCE_PAT" || (echo "Missing VSCE_PAT secret" && exit 1)
          test -n "$OVSX_PAT" || (echo "Missing OVSX_PAT secret" && exit 1)

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate release tag matches extension version
        if: github.event_name == 'release'
        run: |
          TAG="${{ github.event.release.tag_name }}"
          PREFIX="vscode-extension-v"

          if [[ "$TAG" != ${PREFIX}* ]]; then
            echo "Release tag must start with '${PREFIX}'. Got '$TAG'."
            exit 1
          fi

          TAG_VERSION="${TAG#$PREFIX}"
          PACKAGE_VERSION=$(bun -e 'console.log(require("./packages/vscode-extension/package.json").version)')

          if [[ "$TAG_VERSION" != "$PACKAGE_VERSION" ]]; then
            echo "Tag version '$TAG_VERSION' does not match package.json version '$PACKAGE_VERSION'."
            exit 1
          fi

          echo "Release tag version matches package.json version: $PACKAGE_VERSION"

      - name: Build extension
        run: bun run --cwd "$EXT_DIR" build

      - name: Package extension
        run: bunx @vscode/vsce package --no-dependencies -o "$VSIX_PATH"
        working-directory: ${{ env.EXT_DIR }}

      - name: Publish to VS Code Marketplace
        run: bunx @vscode/vsce publish --packagePath "$VSIX_PATH" --no-dependencies -p "$VSCE_PAT"
        working-directory: ${{ env.EXT_DIR }}

      - name: Publish to Open VSX
        run: bunx ovsx publish "$VSIX_PATH" -p "$OVSX_PAT"
        working-directory: ${{ env.EXT_DIR }}
